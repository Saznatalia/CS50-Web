{% extends "network/layout.html" %}
{% load static %}
{% block body %}
{% if user.is_authenticated %}
    <div class="profile_img">
        <img src="{% static 'default.jpg' %}" alt="Default profile image"> 
        <h5> {{ username }} </h5>
    </div>
    <div class="profile_fol">
        <div>
            {{ n_followers }} <br/>
            FOLLOWERS
        </div>
        <div>
            {{ n_following }} <br/>
            FOLLOWING
        </div> 
    </div>
    {% if user.id != profile_id %}

        {% if profile in user_following_list %}
            YES!!!
            <div class="profile_img" style="padding-top: 20px;">
                <input class='btn btn-primary' type="submit" value="UNFOLLOW" name='follow_btn' onclick="follow(this, '{{ profile_id }}')">
            </div>
        {% else %}
            NO!!!
            <div class="profile_img" style="padding-top: 20px;">
                <input class='btn btn-primary' type="submit" value="FOLLOW" name='follow_btn' onclick="follow(this, '{{ profile_id }}')">
            </div>
        {% endif %}
    {% endif %}

    <div id='posts'>
    {% for post in page_obj %} 
        <h5> <a href="{% url 'profile' profile_id %}"> {{ post.user }} </a></h5>
        {{ post.content }}
        <div class='post_date'>
            {{ post.post_date }}
        </div>
        <i class="fa fa-heart like red" id='heart'></i>
        <span>{{ post.likes|length }}</span>
        <div>
            <hr class="solid">
        </div>
    {% endfor %}
    </div>
{% endif %}
{% endblock %}



{% block script %}

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function follow(btn, id) {
        fetch(`/profile/${id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken':  getCookie('csrftoken')
            },
            body: JSON.stringify({'btn_value': btn.value, 'user_id': id})
        })
        .then(response => {
            console.log(response);
            response.json()
        })
        .then(status => {
            console.log(status);
            if (status == 200) {
                console.log("Success!!!");
                location.reload();
            }
            if (status == 404) {
                console.log("User you want to follow doesn't exist");
            }
        })
    }
</script>
{% endblock %}
